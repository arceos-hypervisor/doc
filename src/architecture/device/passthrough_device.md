# 设备直通（Device Passthrough）

设备直通是一种高级虚拟化技术，允许虚拟机（VM）直接访问和控制物理硬件设备。它本质上是一种特殊的设备模拟方式，其特点是将物理设备完全隔离并独占分配给特定虚拟机使用。这种技术绕过了虚拟化层的常规设备模拟过程，提供了接近原生硬件的性能表现。

## 核心优势

+ 接近原生性能：直通设备几乎能提供与裸机系统相同的性能表现，尤其适用于I/O密集型设备
+ 低延迟响应：最小化了虚拟化层引入的额外延迟，关键应用场景如高性能计算、实时数据处理等尤为重要
+ 功能完整性：虚拟机可访问设备的全部功能集，不受虚拟化层功能模拟的限制
+ 硬件加速：允许使用特定硬件的加速功能（如GPU计算、网卡卸载等）

## 技术实现机制

设备直通技术主要依赖于以下关键技术：

+ IOMMU（I/O内存管理单元）：负责虚拟机I/O地址到物理地址的转换，保障安全隔离
+ 中断重映射：将设备中断正确路由到对应的虚拟机
+ DMA重映射：确保设备的直接内存访问操作被正确限制在虚拟机的内存空间内

## axvisor设备直通配置解析

以下是[Axvisor](https://github.com/arceos-hypervisor/axvisor)在ARM平台上基于QEMU架构实现的设备直通配置示例：

```
Pass-through devices.
# Name Base-Ipa Base-Pa Length Alloc-Irq.
passthrough_devices = [
    ["intc@8000000", 0x800_0000, 0x800_0000, 0x50_000, 0x1],
    ["pl011@9000000", 0x900_0000, 0x904_0000, 0x1000, 0x1],
    ["pl031@9010000", 0x901_0000, 0x901_0000, 0x1000, 0x1],
    ["pl061@9030000", 0x903_0000, 0x903_0000, 0x1000, 0x1],
    ["virtio_mmio", 0xa00_0000, 0xa00_0000, 0x4000, 0x1],
]
```

**配置参数详解**

每个设备条目包含5个关键参数：

+ 设备标识符（Name）：唯一标识直通设备，通常包含设备类型和基址信息
+ 中间物理地址（Base-Ipa）：虚拟机内部看到的设备基址，用于VM内部的内存映射
+ 物理地址（Base-Pa）：设备在宿主机上的实际物理内存地址
+ 映射长度（Length）：设备内存映射区域的大小，以字节为单位
+ 中断分配标志（Alloc-Irq）：控制是否为该设备分配中断资源（1=启用，0=禁用）

**示例中的直通设备详情**
| 设备名称 | 功能描述 | 技术特点 | 
| ------- | ------- | ------- |
| `intc@8000000` | 中断控制器 | 管理系统中断，允许VM直接处理硬件中断事件 |
| `pl011@9000000` | PL011 UART串口控制器 | 提供串行通信能力，常用于调试和控制台访问|
| `pl031@9010000` | PL031实时时钟(RTC) | 提供精确的时间功能，确保VM时间准确性 |
| `pl061@9030000` | PL061 GPIO控制器 | 管理通用输入/输出接口，用于控制外部设备 |
| `virtio_mmio` | VirtIO内存映射I/O设备 | 提供高效的半虚拟化I/O接口，平衡性能与兼容性 |

设备直通是构建高性能虚拟化环境的关键组件，可以实现在保持虚拟化灵活性的同时，提供接近于物理机的性能。